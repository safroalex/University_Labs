      SUBROUTINE RKFS(F,NEQN,Y,T,TOUT,RELERR,ABSERR,IFLAG,
     *                YP,H,F1,F2,F3,F4,F5,SAVRE,SAVAE,
     *                NFE,KOP,INIT,JFLAG,KFLAG)
C
C     METO PHE-KTTA-EEPA ETBEPTOO-TOO OPKA
C     RKFS HTEPPET CCTEM OKHOBEHHX E-
C     PEHAHX PABHEH EPBOO OPKA(CM. KOM-
C     MEHTAP K RKF45). MACCB YP,F1,F2,F3,F4  F5
C     (PAMEPHOCT O KPAHE MEPE NEQN)  EPEMEH-
C     HE H,SAVRE,SAVAE,NFE,KOP,INIT,JFLAG  KFLAG
C     COTC BHTP POPAMM  BHECEH B
C     CCOK BOBA,TO COXPAHT X OPEEEH-
C     HOCT P OBTOPHOM OPAEH.OTOM X HA-
C     EH HE OH  MEHTC  OOBATEEM.
C     BOMOH HTEPEC PECTABT APAMETP
C     YP  -POBOHA BEKTOPA PEEH B TOKE T
C     H   -PEOAAEM PAMEP AA  OEPEHOO TAA
C     NFE -CETK CA BCEH HK
C
      LOGICAL HFAILD,OUTPUT
C
      INTEGER NEQN,IFLAG,NFE,KOP,INIT,JFLAG,KFLAG
      REAL Y(NEQN),T,TOUT,RELERR,ABSERR,H,YP(NEQN),
     *     F1(NEQN),F2(NEQN),F3(NEQN),F4(NEQN),F5(NEQN),
     *     SAVRE,SAVAE
C
C     EXTERNAL F
C
      REAL A,AE,DT,EE,EEOET,ESTTOL,ET,HMIN,REMIN,
     *     RER,S,SCAL,TOL,TOLN,U26,EPSP1,EPS,YPK
C
      INTEGER K,MAXNFE,MFLAG
C
      REAL AMAX1,AMIN1
C
C     REMIN-TO MHMAHOE OCTMOE HAEHE 
C     RELERR.OTK OT O TO OPOPAMME
C     OEE BCOK TOHOCT OHO CTOT OEH
C     OPOO  AACT ECEH.
C
      DATA REMIN/1.E-12/
C
C     CTOMOCT CETA KOHTPOPETC TPEOBAHEM,
C     TO KOECTBO BCEH HK O O-
C     PAHEHO BEHO,PTEHO PABHO HA-
C     EH APAMETPA MAXNFE.PHTOE EC HAE-
C     HE PMEPHO COOTBETCTBET 500 AAM.
C
      DATA MAXNFE/3000/
C
C     POBEPT BXOHE APAMETP
C
      IF(NEQN.LT.1)GO TO 10
      IF((RELERR.LT.0.0).OR.(ABSERR.LT.0.0))GO TO 10
      MFLAG=IABS(IFLAG)
      IF((MFLAG.EQ.0).OR.(MFLAG.GT.8))GO TO 10
      IF(MFLAG.NE.1)GO TO 20
C
C     EPB BOB,BCT MAHHOE COH
C
      EPS=1.0
    5 EPS=EPS/2.0
      EPSP1=EPS+1.
      IF(EPSP1.GT.1.)GO TO 5
      U26=26.*EPS
      GO TO 50
C
C     OKA BXOHO HOPMA
C
   10 IFLAG=8
      RETURN
C
C     POBEPT BOMOHOCT POOEH
C
   20 IF((T.EQ.TOUT).AND.(KFLAG.NE.3))GO TO 10
      IF(MFLAG.NE.2)GO TO 25
C
C     IFLAG=+2  -2
C
      IF((KFLAG.EQ.3).OR.(INIT.EQ.0))GO TO 45
      IF(KFLAG.EQ.4)GO TO 40
      IF((KFLAG.EQ.5).AND.(ABSERR.EQ.0.0))GO TO 30
      IF((KFLAG.EQ.6).AND.(RELERR.LE.SAVRE).AND.
     *(ABSERR.LE.SAVAE))GO TO 30
      GO TO 50
C
C     IFLAG=3,4,5,6,7  8
C
   25 IF(IFLAG.EQ.3)GO TO 45
      IF(IFLAG.EQ.4)GO TO 40
      IF((IFLAG.EQ.5).AND.(ABSERR.GT.0.0))GO TO 45
C
C     HTEPPOBAHE HE POOAT,OCKOK O-
C     OBATE HE BOH HCTPK,COOTBETCTBX
C     HAEHM IFLAG=5,6,7  8
C
   30 PRINT 35
   35 FORMAT(/20X,48HHTEPPOBAHE PEPBAHO, OCKOK OOBATE ,
     *11HHE BOH/20X,34HHCTPK RKF45, COOTBETCTBX ,
     *27HHAEHM IFLAG=5,6,7  8)
      STOP
C
C     EPEOPEET CETK CA BCEH HK
C
   40 NFE=0
      IF(MFLAG.EQ.2)GO TO 50
C
C     EPEOPEET HAEHE FLAG,CTAHOBEHHOE
C     P PEEM OPAEH
C
   45 IFLAG=JFLAG
      IF(KFLAG.EQ.3)MFLAG=IABS(IFLAG)
C
C     COXPAHT BXOHOE HAEHE IFLAG  CTAHOBT
C     HAEHE FLAG, COOTBETCTBEE POOEH,
C      E POBEPK
C
   50 JFLAG=IFLAG
      KFLAG=0
C
C     COXPAHT HAEH RELERR  ABSERR  BXOHO
C     POBEPK P OCEX OPAEHX
C
      SAVRE=RELERR
      SAVAE=ABSERR
C
C     CTAHOBT HAEHE PAH  OTHOCTE-
C     HO OPEHOCT,PABHOE KAK MHMM 2*EPS+
C     REMIN,TO EAT TPHOCTE,CBAHHX
C     C TPEOBAHEM HEOCTMO TOHOCT
C
      RER=2.*EPS+REMIN
      IF(RELERR.GE.RER)GO TO 55
C
C     AAHHA PAHA OTHOCTEHO OPEHOCT
C     CKOM MAA
C
      RELERR=RER
      IFLAG=3
      KFLAG=3
      RETURN
C
   55 DT=TOUT-T
C
      IF(MFLAG.EQ.1)GO TO 60
      IF(INIT.EQ.0)GO TO 65
      GO TO 80
C
C     PCBOEHE HAAHX HAEH (HPOBA-
C             HE)-CTAHOBT HAEHE KAATE
C             OKOHAH HPOBAH,INIT
C             CTAHOBT HAEHE KAATE C-
C             KOM OOO ATPEOBAHHOO CA B-
C             XOHX TOEK,KOP
C             BCT HAAHE POBOHE
C             CTAHOBT HAEHE CETKA CA
C             BCEH HK,NFE
C             OEHT HAEH BEH AA
C
   60 INIT=0
      KOP=0
C
      A=T
      CALL F(A,Y,YP)
      NFE=1
      IF(T.NE.TOUT)GO TO 65
      IFLAG=2
      RETURN
C
   65 INIT=1
      H=ABS(DT)
      TOLN=0.
      DO 70 K=1,NEQN
      TOL=RELERR*ABS(Y(K))+ABSERR
      IF(TOL.LE.0)GO TO 70
      TOLN=TOL
      YPK=ABS(YP(K))
      IF(YPK*H**5.GT.TOL)H=(TOL/YPK)**0.2
   70 CONTINUE
      IF(TOLN.LE.0.0)H=0.0
      H=AMAX1(H,U26*AMAX1(ABS(T),ABS(DT)))
      JFLAG=ISIGN(2,IFLAG)
C
C     PCBOT BEHE AA HAK,COOTBETCTB
C     HTEPPOBAH B HAPABEH OT T K TOUT
C
   80 H=SIGN(H,DT)
C
C     POBEPKA, HACKOKO CEPEHO BHE HA RKF45
C     CKOM OOO ATPEOBAHHOO CA BXO-
C     HX TOEK
C
      IF(ABS(H).GE.2.0*ABS(DT))KOP=KOP+1
      IF(KOP.NE.100)GO TO 85
C
C     PEMEPHA ACTOTA BXOOB
C
      KOP=0
      IFLAG=7
      RETURN
C
   85 IF(ABS(DT).GT.U26*ABS(T))GO TO 95
C
C     EC OEH KO K TOKE BXOA,POKCTPAO-
C     POBAT  BEPHTC O MECT BOBA
C
      DO 90 K=1,NEQN
   90 Y(K)=Y(K)+DT*YP(K)
      A=TOUT
      CALL F(A,Y,YP)
      NFE=NFE+1
      GO TO 300
C
C     PCBOT HAAHOE HAEHE HKATOP TOK
C     BXOA
C
   95 OUTPUT=.FALSE.
C
C     TO EAT HEOPABAHHOO MAHHOO H
C     P BCEH HK OT PAH OPEHO-
C     CTE,POMACTAPOBAT T PAH
C
      SCALE=2./RELERR
      AE=SCALE*ABSERR
C
C     OAOBOE HTEPPOBAHE
C
  100 HFAILD=.FALSE.
C
C     CTAHOBT HAMEH OCTM BEH AA
C
      HMIN=U26*ABS(T)
C
C     CPABT P HEOXOMOCT BEH AA,
C     TO OCTHT TOK BXOA. PACCTAT HA
C     BA AA BEPE,TO EAT CKOM PEKX
C     MEHEH B BEHE AA  TEM CAMM MEH-
C     T BHE BXOHX TOEK HA POPAMM.
C
      DT=TOUT-T
      IF(ABS(DT).GE.2.*ABS(H))GO TO 200
      IF(ABS(DT).GT.ABS(H))GO TO 150
C
C     CE CEH A ABEPT HTEPPO-
C     BAHE O KAAHHO TOK BXOA
C
      OUTPUT=.TRUE.
      H=DT
      GO TO 200
C
  150 H=0.5*DT
C
C
C
C     BHTPEHH OHOAOB HTEPATOP
C
C     PAH OPEHOCTE  POMACTAPOBAH,
C     TO EAT HEOPABAHHOO MAHHOO H
C     P BCEH HK OT HX.
C     TO EAT OPAEH B H HAMEHATE
C     B TECTE,OTHOCTEHA OKA MEPETC  O
C     OTHOEH K CPEHEM   BEH PEEH
C     B HAAE  KOHE AA.
C     B OPME,OEHBAE OK,POBEEHA
C     PPOBKA CAAEMX,MEHAA OTEP
C     BEPHX HAKOB.
C     TO PAAT ME COO PAHE APMEHT,
C      H HE OCKATC HAEH,MEHE MHO-
C     EHHO HA 26 OK OKPEH B T.
C     BBEEH PAKTECKE OPAHEH HA CKOPOCT
C     MEHEH BEH AA,TO CAT PO-
C     ECC BOPA TO BEH  EAT PEMEP-
C     HOO EE PAPOCA B AAAX C HAPEHEM HEPE-
C     PBHOCT.
C      PEOCTOPOHOCT POPAMMA EPET 9/10 OT TO
C     BEH AA,KOTOPA HHA O EE OEHKE.
C     ECHA AHHOM AE A HEAHA OTKA
C     TO P AHPOBAH CEEO BEEHE
C     H AA HE OCKAETC. TO OBAET EK-
C     TBHOCT POPAMM  AA C PAPBAM 
C     B OEM CAE,OCKOK COETC OKA-
C     HA KCTPAO  OOHTEHA PEOCTO-
C     POHOCT KAETC OPABAHHO.
C
C
C     POBEPT CO BCEH POBOHX.EC
C     OHO HE PEBAET CTAHOBEHHOO PEEA,O-
C     POOBAT POOT HTEPPOBAHE C T O T+H
C
  200 IF(NFE.LE.MAXNFE)GO TO 220
C
C     CKOM OA PAOTA
C
      IFLAG=4
      KFLAG=4
      RETURN
C
C     POOT PEHHOE PEEHE HA OH A H H
C
  220 CALL FEHL(F,NEQN,Y,T,H,YP,F1,F2,F3,F4,F5,F1)
      NFE=NFE+5
C
C     BCT  CPABHT OCTME PAH 
C     OEHK OKAHO O,A ATEM CHT MACTA-
C     POBAHE PAH.AMETTE,TO OTHOCTEHA
C     OKA MEPETC O OTHOEH K CPEHEM 
C     BEH PEEH B HAAE  KOHE AA.
C
      EEOET=0.
      DO 250 K=1,NEQN
      ET=ABS(Y(K))+ABS(F1(K))+AE
      IF(ET.GT.0.)GO TO 240
C
C     HEPABHA PAHA OPEHOCT
C
      IFLAG=5
      KFLAG=5
      RETURN
C
  240 EE=ABS((-2090.*YP(K)+(21970.*F3(K)-15048.*F4(K)))
     *  +(22528.*F2(K)-27360.*F5(K)))
  250 EEOET=AMAX1(EEOET,EE/ET)
C
      ESTTOL=ABS(H)*EEOET*SCALE/752400.
C
      IF(ESTTOL.LE.1.0)GO TO 260
C
C
C     HEAH A
C            MEHT BEH AA  CHOBA O-
C            POOBAT
C            MEHEHE OPAHBAETC CH MHO-
C            TEEM 1/10
C
      HFAILD=.TRUE.
      OUTPUT=.FALSE.
      S=0.1
      IF(ESTTOL.LT.59049.)S=0.9/ESTTOL**0.2
      H=S*H
      IF(ABS(H).GT.HMIN)GO TO 200
C
C     AAHHA PAHA OK HEOCTMA AE P
C     HAMEHE OCTMO BEHE AA
C
      IFLAG=6
      KFLAG=6
      RETURN
C
C
C     CEH A
C            OMECTT B MACCB Y PEEHE B TOKE
C            T+H  BCT POBOHE B TO
C            TOKE
C
  260 T=T+H
      DO 270 K=1,NEQN
  270 Y(K)=F1(K)
      A=T
      CALL F(A,Y,YP)
      NFE=NFE+1
C
C
C     BPAT BEH CEEO AA
C     BEEHE OPAHEHO MHOTEEM 5
C     EC HA AHHOM AE A HEAHA
C     OTKA,TO  CEEO HE O-
C     CKAETC BOP OE BEH AA
C
      S=5.
      IF(ESTTOL.GT.1.889568E-4)S=0.9/ESTTOL**0.2
      IF(HFAILD)S=AMIN1(S,1.0)
      H=SIGN(AMAX1(S*ABS(H),HMIN),H)
C
C     KOHE OHOAOBOO HTEPATOPA
C
C
C     HHO  EAT OEPEHO A
C
      IF(OUTPUT)GO TO 300
      IF(IFLAG.GT.0)GO TO 100
C
C
C     HTEPPOBAHE CEHO ABEPEHO
C
C     PEM OHOAOBOO HTEPPOBAH
C
      IFLAG=-2
      RETURN
C
C     PEM HTEPPOBAH HA HTEPBAE
C
  300 T=TOUT
      IFLAG=2
      RETURN
C
      END
